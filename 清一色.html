<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>清一色 テンパイ・何待ちクイズ（萬子のみ・安定版）</title>
<style>
  :root { --w:48px; --h:64px; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin:20px; display:flex; flex-direction:column; gap:14px; align-items:center; }
  h1 { font-size:20px; margin:0 0 6px; }
  .wrap { display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start; }
  .panel { border:1px solid #ccc; border-radius:12px; padding:12px; background:#fafafa; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .tiles { display:flex; gap:6px; flex-wrap:wrap; align-items:flex-start; }

  /* 牌の見た目（数字黒＋萬赤／縦書き） */
  .pai {
    width: var(--w); height: var(--h);
    border-radius: 6px;
    background: linear-gradient(#fff, #f6f6f6);
    border: 1px solid #bdbdbd;
    box-shadow: inset 0 0 0 2px #fff, 0 1px 2px rgba(0,0,0,.06);
    display:flex; align-items:center; justify-content:center;
    writing-mode: vertical-rl; text-orientation: upright;
  }
  .pai .kanji { font-family:"Hiragino Mincho ProN","Yu Mincho","Noto Serif CJK JP",serif; font-weight:700; font-size:22px; color:#000; line-height:1; }
  .pai .man   { font-family:"Hiragino Mincho ProN","Yu Mincho","Noto Serif CJK JP",serif; font-weight:700; font-size:22px; color:#c62828; line-height:1; }
  .pai.small { width:40px; height:54px; }
  .pai.mark  { outline:3px solid #ff9800; outline-offset:2px; }

  .btn { padding:10px 14px; border-radius:12px; border:1px solid #bbb; background:#f7f7f7; font-weight:800; cursor:pointer; }
  .answers { display:flex; gap:8px; flex-wrap:wrap; }
  .ans { border:none; background:transparent; padding:0; cursor:pointer; }
  .ans .pai { transition: transform .05s ease, outline-color .1s; }
  .ans.selected .pai { outline:3px solid #1976d2; outline-offset:2px; transform: translateY(-1px); }
  .ans.correct  .pai { outline:3px solid #2e7d32; outline-offset:2px; }
  .ans.wrong    .pai { outline:3px solid #d32f2f; outline-offset:2px; }

  .muted { opacity:.75; }
  .score { font-weight:800; }
  .small { font-size:12px; color:#666; }
  #msg.error { color:#d32f2f; font-weight:700; }
</style>
</head>
<body>
  <h1>清一色 テンパイ・何待ちクイズ（<span class="muted">萬子のみ</span>）</h1>

  <div class="panel row">
    <label><input type="checkbox" id="allowStd" checked /> 面子手OK</label>
    <label><input type="checkbox" id="allowChiitoi" /> 七対子OK</label>
  </div>

  <div class="wrap">
    <div class="panel" style="min-width:380px;">
      <div class="row"><strong>問題 <span id="qno">1</span></strong>　<span class="score">正解 <span id="good">0</span>/<span id="total">0</span></span></div>
      <div class="row small">下の13枚でテンパイ。アガれる牌（複数可）を選んで「解答する」。</div>
      <div id="hand" class="tiles" style="margin:6px 0 8px;"></div>

      <div class="answers" id="answers"></div>
      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn" id="submit">解答する (Enter)</button>
        <button type="button" class="btn" id="reveal">答えを表示</button>
        <button type="button" class="btn" id="next">次の問題 (N)</button>
      </div>
      <div class="row small muted" id="msg">—</div>
    </div>

    <div class="panel" style="min-width:260px;">
      <div class="row"><strong>正解の待ち</strong></div>
      <div id="waits" class="tiles" style="min-height:70px;"></div>
      <div class="row small">デバッグ</div>
      <pre id="debug" class="small" style="margin:0;">—</pre>
    </div>
  </div>

<script>
(()=> {
  // DOM
  const allowStd    = document.getElementById('allowStd');
  const allowChiitoi = document.getElementById('allowChiitoi');
  const handEl = document.getElementById('hand');
  const answersEl = document.getElementById('answers');
  const waitsEl = document.getElementById('waits');
  const msgEl = document.getElementById('msg');
  const debugEl = document.getElementById('debug');
  const qnoEl = document.getElementById('qno');
  const goodEl = document.getElementById('good');
  const totalEl = document.getElementById('total');
  const submitBtn = document.getElementById('submit');
  const revealBtn = document.getElementById('reveal');
  const nextBtn = document.getElementById('next');

  // 例外は画面に出す
  window.onerror = (m,s,l,c,e)=>{ msgEl.textContent = 'エラー: '+m; msgEl.classList.add('error'); console.error(m,s,l,c,e); };

  const NUM_KANJI = ['','一','二','三','四','五','六','七','八','九'];

  // 状態
  let counts13 = Array(10).fill(0); // 1..9 合計13
  let waits = new Set();
  let qno=0, good=0, total=0;
  let revealed=false;

  // 牌 DOM
  function pai(num, small=false){
    const d = document.createElement('div'); d.className = 'pai'+(small?' small':'');
    const k = document.createElement('span'); k.className='kanji'; k.textContent = NUM_KANJI[num]||'?';
    const m = document.createElement('span'); m.className='man';   m.textContent = '萬';
    d.appendChild(k); d.appendChild(m);
    return d;
  }

  // 描画
  function renderTilesFromCounts(container, cnt){
    container.innerHTML = '';
    for(let i=1;i<=9;i++){
      for(let k=0;k<(cnt[i]||0);k++) container.appendChild(pai(i));
    }
  }
  function renderWaits(show){
    waitsEl.innerHTML=''; if(!show) return;
    [...waits].sort((a,b)=>a-b).forEach(n=>{ const d=pai(n); d.classList.add('mark'); waitsEl.appendChild(d); });
  }

  // 和了判定（清一色前提）
  const sumArr = a=>a.reduce((x,y)=>x+y,0);
  function canMentsu(cnt){
    let i=1; while(i<=9 && cnt[i]===0) i++; if(i>9) return true;
    if(cnt[i]>=3){ cnt[i]-=3; if(canMentsu(cnt)){ cnt[i]+=3; return true; } cnt[i]+=3; }
    if(i<=7 && cnt[i+1]>0 && cnt[i+2]>0){
      cnt[i]--; cnt[i+1]--; cnt[i+2]--;
      if(canMentsu(cnt)){ cnt[i]++; cnt[i+1]++; cnt[i+2]++; return true; }
      cnt[i]++; cnt[i+1]++; cnt[i+2]++;
    }
    return false;
  }
  function isAgariStd(cnt){ // 14枚
    if(sumArr(cnt)!==14) return false;
    for(let j=1;j<=9;j++){
      if(cnt[j]>=2){ cnt[j]-=2; if(canMentsu(cnt)){ cnt[j]+=2; return true; } cnt[j]+=2; }
    }
    return false;
  }
  function isChiitoi(cnt){
    if(sumArr(cnt)!==14) return false;
    let pairs=0; for(let i=1;i<=9;i++){ if(cnt[i]===2) pairs++; else if(cnt[i]===0){} else return false; }
    return pairs===7;
  }
  function waitsFor(c13, stdOK, chiitoiOK){
    const w=new Set(); if(sumArr(c13)!==13) return w;
    for(let t=1;t<=9;t++){
      if(c13[t]===4) continue; // 5枚目は不可
      const tmp=c13.slice(); tmp[t]++;
      if((stdOK && isAgariStd(tmp.slice())) || (chiitoiOK && isChiitoi(tmp.slice()))) w.add(t);
    }
    return w;
  }

  // 出題（14枚の和了手→1枚抜き）
  function randCounts14(){
    const c = Array(10).fill(0);
    while(sumArr(c)<14){
      const i = 1 + Math.floor(Math.random()*9);
      if(c[i]<4) c[i]++;
    }
    return c;
  }
  function randAgari14(stdOK, chiitoiOK){
    for(let tries=0; tries<40000; tries++){
      const c = randCounts14();
      if((stdOK && isAgariStd(c.slice())) || (chiitoiOK && isChiitoi(c.slice()))) return c;
    }
    return null;
  }
  function makeQuestion(){
    const agari = randAgari14(allowStd.checked, allowChiitoi.checked);
    if(!agari){
      // フォールバック（確実にテンパイ）：1〜6を2枚ずつ＋7を1枚 → 7待ち
      const fb = Array(10).fill(0); [1,2,3,4,5,6].forEach(i=>fb[i]=2); fb[7]=1;
      counts13 = fb; waits = new Set([7]); return;
    }
    let idx; do{ idx = 1 + Math.floor(Math.random()*9); } while(agari[idx]===0);
    agari[idx]--;
    counts13 = agari;
    waits = waitsFor(counts13.slice(), allowStd.checked, allowChiitoi.checked);
    if(waits.size===0) return makeQuestion(); // 念のため
  }

  function drawQuestion(){
    qno++; total++; qnoEl.textContent=String(qno); totalEl.textContent=String(total);
    revealed=false; msgEl.textContent='—'; msgEl.classList.remove('error');
    renderTilesFromCounts(handEl, counts13);
    renderWaits(false);

    // 回答（1〜9）複数選択
    answersEl.innerHTML='';
    for(let i=1;i<=9;i++){
      const btn = document.createElement('button'); btn.type='button'; btn.className='ans'; btn.dataset.num=String(i);
      btn.appendChild(pai(i,true));
      btn.addEventListener('click', ()=> btn.classList.toggle('selected'));
      answersEl.appendChild(btn);
    }

    debugEl.textContent = '手牌: '+counts13.slice(1).join(', ')+'\n待ち: (非表示)';
  }

  function judge(){
    if(revealed) return;
    const chosen = new Set([...answersEl.children].filter(b=>b.classList.contains('selected')).map(b=>+b.dataset.num));
    const pick=[...chosen].sort((a,b)=>a-b), ans=[...waits].sort((a,b)=>a-b);
    const correctAll = JSON.stringify(pick)===JSON.stringify(ans);
    if(correctAll){ good++; goodEl.textContent=String(good); msgEl.textContent='🟢 完全正解！'; }
    else{
      const wrong = pick.filter(n=>!waits.has(n));
      const missed = ans.filter(n=>!chosen.has(n));
      msgEl.textContent = `🔴 不正解  誤選択:${wrong.join(',')||'なし'} / 見逃し:${missed.join(',')||'なし'}`;
    }
    revealed=true; renderWaits(true);
    [...answersEl.children].forEach(el=>{
      const n=+el.dataset.num; el.disabled=true;
      if(waits.has(n)) el.classList.add('correct');
      if(!waits.has(n) && el.classList.contains('selected')) el.classList.add('wrong');
    });
  }

  function next(){ makeQuestion(); drawQuestion(); }

  // イベント
  submitBtn.addEventListener('click', judge);
  revealBtn.addEventListener('click', ()=>{
    if(!revealed){
      revealed=true; renderWaits(true);
      [...answersEl.children].forEach(el=>{ el.disabled=true; if(waits.has(+el.dataset.num)) el.classList.add('correct'); });
      msgEl.textContent='解答を表示しました';
    }
  });
  nextBtn.addEventListener('click', next);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ judge(); } if(e.key.toLowerCase()==='n'){ next(); } });
  allowStd.addEventListener('change', next);
  allowChiitoi.addEventListener('change', next);

  // 初回
  next();
})();
</script>
</body>
</html>
