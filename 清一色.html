<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ¸…ä¸€è‰² ãƒ†ãƒ³ãƒ‘ã‚¤ãƒ»ä½•å¾…ã¡ã‚¯ã‚¤ã‚ºï¼ˆè¬å­ãƒ»ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œãƒ»å®‰å®šç‰ˆï¼‰</title>
<style>
  :root{ --w: clamp(44px, 10vw, 64px); --h: calc(var(--w) * 1.45); }
  *{ box-sizing: border-box; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin:12px; text-align:center; }
  h2{ font-size: clamp(16px, 4.5vw, 22px); margin: 0.2em 0 0.6em; }
  .board{ display:flex; justify-content:center; flex-wrap:wrap; gap:6px; margin: 0.6em; }
  .choices{ display:flex; justify-content:center; flex-wrap:wrap; gap:8px; margin: 0.6em; }

  /* ç‰Œï¼šæ•°å­—ã¯é»’ã€è¬ã¯èµ¤ã€‚ç¸¦æ›¸ãã€‚ã‚¿ãƒƒãƒ—é ˜åŸŸã¯>=44pxç¢ºä¿ */
  .tile{
    width: var(--w); height: var(--h);
    border: 2px solid #8a8a8a; border-radius: 6px; background:#fff;
    box-shadow: inset 0 0 0 2px #fff, 0 1px 2px rgba(0,0,0,.06);
    display:flex; align-items:center; justify-content:center;
    writing-mode: vertical-rl; text-orientation: upright;
    font-size: clamp(22px, calc(var(--w) * 0.58), 38px); font-weight: 800; color:#000;
    line-height: 1; user-select: none;
  }
  .tile .man{ color:#c62828; font-size:0.95em; }
  .choices .tile{ cursor:pointer; }
  .choices .selected{ outline: 3px solid #1976d2; outline-offset: 2px; }

  button{ padding:10px 14px; border-radius:12px; border:1px solid #777; background:#f7f7f7; font-weight:800; font-size:clamp(14px,3.4vw,16px); }
  #streakRow button{ font-size: clamp(14px, 4vw, 18px); padding: 8px 14px; }
  #result{ margin: .8rem 0; font-weight:800; }
  .controls{ display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; margin:6px 0 2px; font-size:clamp(12px,3.2vw,14px); }

  /* UDï¼ˆé«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼‰ãƒ¢ãƒ¼ãƒ‰ */
  .ud .tile{ border-color:#000; box-shadow:none; }
  .ud .choices .selected{ outline-width:4px; }
  .ud button{ border-color:#000; }

  #err{ color:#d32f2f; font-weight:700; font-size:12px; margin-top:6px; }
  #streakRow{ font-size: clamp(14px, 4vw, 18px); }
  #streakRow strong{ font-size: 1.1em; }
</style>
</head>
<body>
  <h2>æ¸…ä¸€è‰² ãƒ†ãƒ³ãƒ‘ã‚¤ãƒ»ä½•å¾…ã¡ã‚¯ã‚¤ã‚ºï¼ˆè¬å­ã®ã¿ï¼‰</h2>
  <div id="problem" class="board" aria-label="å•é¡Œã®æ‰‹ç‰Œ"></div>

  <div id="choices" class="choices" aria-label="è§£ç­”å€™è£œ"></div>

  <!-- â–¼ é€£ç¶šæ­£è§£ è¡¨ç¤ºè¡Œï¼ˆè¿½åŠ ï¼‰ -->
  <div id="streakRow" style="margin-top:4px; font-size:clamp(14px, 4vw, 20px); display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;">
    <span>é€£ç¶šæ­£è§£æ•°ï¼š<strong><span id="streakNow">0</span></strong>å› (æœ€é«˜ <strong><span id="streakBest">0</span></strong>å›)</span>
    <button type="button" id="streakReset">æ­£è§£æ•°ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <!-- â–² é€£ç¶šæ­£è§£ è¡¨ç¤ºè¡Œ -->

  <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
    <button type="button" id="btnAnswer">è§£ç­”ã™ã‚‹ (Enter)</button>
    <button type="button" id="btnReveal">ç­”ãˆã‚’è¡¨ç¤º</button>
    <button type="button" id="btnNext">æ¬¡ã®å•é¡Œ (N)</button>
  </div>

  <div class="controls">
    <label>ã‚µã‚¤ã‚º: <input id="sizeRange" type="range" min="36" max="80" step="1" value="0"> <span id="sizeLabel">è‡ªå‹•</span></label>
    <label><input id="udToggle" type="checkbox"> UDãƒ¢ãƒ¼ãƒ‰ï¼ˆé«˜ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆï¼‰</label>
  </div>

  <div id="result" aria-live="polite"></div>
  <div id="err" aria-live="polite"></div>

<script>
(() => {
  // ===== å®‰å…¨ç­–ï¼šã‚¨ãƒ©ãƒ¼ã¯UIã«è¡¨ç¤º =====
  const errEl = document.getElementById('err');
  window.onerror = (m, s, l, c, e) => { errEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + m; console.error(m, s, l, c, e); };

  // ===== DOM =====
  const problemEl = document.getElementById('problem');
  const choicesEl = document.getElementById('choices');
  const resultEl  = document.getElementById('result');
  const btnAnswer = document.getElementById('btnAnswer');
  const btnReveal = document.getElementById('btnReveal');
  const btnNext   = document.getElementById('btnNext');
  const sizeRange = document.getElementById('sizeRange');
  const sizeLabel = document.getElementById('sizeLabel');
  const udToggle  = document.getElementById('udToggle');
  // â–¼ é€£ç¶šæ­£è§£UI
  const streakNowEl  = document.getElementById('streakNow');
  const streakBestEl = document.getElementById('streakBest');
  const streakResetBtn = document.getElementById('streakReset');

  const NUMS = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];

  // ===== çŠ¶æ…‹ =====
  let problemCounts = Array(10).fill(0); // 1..9 åˆè¨ˆ13
  let waits = new Set();
  let selected = new Set();

  // é€£ç¶šæ­£è§£ã‚«ã‚¦ãƒ³ã‚¿
  let streak = 0;
  let bestStreak = 0;
  const LS_STREAK = 'chinitsu_streak_now';
  const LS_BEST   = 'chinitsu_streak_best';

  function loadStreak(){
    try{
      const s = parseInt(localStorage.getItem(LS_STREAK)||'0',10);
      const b = parseInt(localStorage.getItem(LS_BEST)||'0',10);
      if(!isNaN(s)) streak = s;
      if(!isNaN(b)) bestStreak = b;
    }catch(_){ }
  }
  function saveStreak(){
    try{
      localStorage.setItem(LS_STREAK, String(streak));
      localStorage.setItem(LS_BEST,   String(bestStreak));
    }catch(_){ }
  }
  function renderStreak(){
    if(streakNowEl)  streakNowEl.textContent  = String(streak);
    if(streakBestEl) streakBestEl.textContent = String(bestStreak);
  }

  if(streakResetBtn){
    streakResetBtn.addEventListener('click', ()=>{
      streak = 0; bestStreak = 0;
      saveStreak(); renderStreak();
      resultEl.textContent = 'é€£ç¶šæ­£è§£æ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
    });
  }

  // ===== ç‰ŒDOM =====
  function tileNode(n){
    const d = document.createElement('div'); d.className = 'tile';
    d.innerHTML = `${NUMS[n-1]}<span class="man">è¬</span>`;
    return d;
  }

  // ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
  function renderHand(){
    problemEl.innerHTML='';
    for(let i=1;i<=9;i++) for(let k=0;k<problemCounts[i];k++) problemEl.appendChild(tileNode(i));
  }
  function renderChoices(){
    choicesEl.innerHTML='';
    for(let i=1;i<=9;i++){
      const btn = document.createElement('button'); btn.type='button'; btn.className='tile'; btn.dataset.num=i;
      btn.innerHTML = `${NUMS[i-1]}<span class="man">è¬</span>`;
      btn.addEventListener('click', ()=>{
        if(selected.has(i)){ selected.delete(i); btn.classList.remove('selected'); }
        else{ selected.add(i); btn.classList.add('selected'); }
      });
      choicesEl.appendChild(btn);
    }
  }

  // ===== å½¹åˆ¤å®šï¼ˆæ¸…ä¸€è‰² 1ã‚¹ãƒ¼ãƒ„ï¼‰ =====
  const sum = a=>a.reduce((x,y)=>x+y,0);
  function canMentsu(cnt){
    let i=1; while(i<=9 && cnt[i]===0) i++; if(i>9) return true;
    if(cnt[i]>=3){ cnt[i]-=3; if(canMentsu(cnt)){ cnt[i]+=3; return true; } cnt[i]+=3; }
    if(i<=7 && cnt[i+1]>0 && cnt[i+2]>0){
      cnt[i]--; cnt[i+1]--; cnt[i+2]--;
      if(canMentsu(cnt)){ cnt[i]++; cnt[i+1]++; cnt[i+2]++; return true; }
      cnt[i]++; cnt[i+1]++; cnt[i+2]++;
    }
    return false;
  }
  function isAgariStd(cnt){ if(sum(cnt)!==14) return false; for(let j=1;j<=9;j++){ if(cnt[j]>=2){ cnt[j]-=2; if(canMentsu(cnt)){ cnt[j]+=2; return true; } cnt[j]+=2; } } return false; }
  function isChiitoi(cnt){ if(sum(cnt)!==14) return false; let p=0; for(let i=1;i<=9;i++){ if(cnt[i]===2) p++; else if(cnt[i]!==0) return false; } return p===7; }
  function waitsFor(c13){ const w=new Set(); if(sum(c13)!==13) return w; for(let t=1;t<=9;t++){ if(c13[t]===4) continue; const tmp=c13.slice(); tmp[t]++; if(isAgariStd(tmp.slice()) || isChiitoi(tmp.slice())) w.add(t); } return w; }

  // ===== å•é¡Œç”Ÿæˆï¼ˆ14æšã‚¢ã‚¬ãƒªâ†’1æšæŠœãï¼‰ =====
  function randCounts14(){ const c=Array(10).fill(0); while(sum(c)<14){ const i=1+Math.floor(Math.random()*9); if(c[i]<4) c[i]++; } return c; }
  function randAgari14(){ for(let t=0;t<40000;t++){ const c=randCounts14(); if(isAgariStd(c.slice()) || isChiitoi(c.slice())) return c; } return null; }
  function makeProblem(){
    const agari = randAgari14();
    if(!agari){ // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆä¸ƒå¯¾å­ãƒ†ãƒ³ãƒ‘ã‚¤ï¼‰
      const fb = Array(10).fill(0); [1,2,3,4,5,6].forEach(i=>fb[i]=2); fb[7]=1; problemCounts=fb; waits=new Set([7]); return; }
    let idx; do{ idx=1+Math.floor(Math.random()*9); } while(agari[idx]===0);
    agari[idx]--; problemCounts=agari; waits=waitsFor(problemCounts.slice()); if(waits.size===0) return makeProblem();
  }

  // ===== åˆ¤å®š =====
  function judge(){
    const pick=[...selected].sort((a,b)=>a-b).join(',');
    const ans=[...waits].sort((a,b)=>a-b).join(',');
    if(pick===ans){
      resultEl.textContent='ğŸŸ¢ å®Œå…¨æ­£è§£ï¼';
      streak++;
      if(streak>bestStreak) bestStreak=streak;
    } else {
      const chosen=[...selected]; const w=[...waits];
      const wrong = chosen.filter(n=>!waits.has(n));
      const missed = w.filter(n=>!selected.has(n));
      resultEl.textContent = `âŒ ä¸æ­£è§£ èª¤é¸æŠ:${wrong.join(',')||'ãªã—'} / è¦‹é€ƒã—:${missed.join(',')||'ãªã—'}`;
      streak = 0; // é€£ç¶šã¯ãƒªã‚»ãƒƒãƒˆ
    }
    saveStreak();
    renderStreak();
    // æ­£è§£ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    [...choicesEl.children].forEach(el=>{
      const n=+el.dataset.num; if(waits.has(n)) el.classList.add('selected'); else if(selected.has(n)) el.style.outline='3px solid #d32f2f';
      el.disabled=true;
    });
  }

  // ===== æ¬¡ã®å•é¡Œ =====
  function next(){ selected.clear(); resultEl.textContent=''; errEl.textContent=''; makeProblem(); renderHand(); renderChoices(); }

  // ===== ã‚µã‚¤ã‚ºï¼†UD =====
  function applySize(pxOrAuto){
    if(pxOrAuto==='auto'){ document.documentElement.style.setProperty('--w','clamp(44px, 10vw, 64px)'); sizeLabel.textContent='è‡ªå‹•'; }
    else{ document.documentElement.style.setProperty('--w', pxOrAuto+'px'); sizeLabel.textContent=pxOrAuto+'px'; }
    document.documentElement.style.setProperty('--h','calc(var(--w) * 1.45)');
  }
  sizeRange.addEventListener('input', ()=>{ const v=sizeRange.valueAsNumber||0; if(v<=0) applySize('auto'); else applySize(v); });
  udToggle.addEventListener('change', ()=>{ document.body.classList.toggle('ud', udToggle.checked); });

  // ===== ãƒœã‚¿ãƒ³ / ã‚­ãƒ¼ =====
  btnAnswer.addEventListener('click', judge);
  btnReveal.addEventListener('click', ()=>{ resultEl.textContent = 'æ­£è§£: ' + [...waits].sort((a,b)=>a-b).map(n=>NUMS[n-1]+'è¬').join(' '); });
  btnNext.addEventListener('click', next);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Enter') judge(); if(e.key.toLowerCase()==='n') next(); });

  // åˆæœŸåŒ–
  loadStreak();
  renderStreak();
  applySize('auto');
  next();
})();
</script>
</body>
</html>
