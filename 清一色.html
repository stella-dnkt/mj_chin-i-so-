<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ¸…ä¸€è‰² ãƒ†ãƒ³ãƒ‘ã‚¤ãƒ»ä½•å¾…ã¡ã‚¯ã‚¤ã‚ºï¼ˆè¬å­ã®ã¿ãƒ»å®‰å®šç‰ˆï¼‰</title>
<style>
  :root { --w:48px; --h:64px; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; margin:20px; display:flex; flex-direction:column; gap:14px; align-items:center; }
  h1 { font-size:20px; margin:0 0 6px; }
  .wrap { display:flex; gap:18px; flex-wrap:wrap; align-items:flex-start; }
  .panel { border:1px solid #ccc; border-radius:12px; padding:12px; background:#fafafa; box-shadow:0 1px 2px rgba(0,0,0,.04); }
  .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .tiles { display:flex; gap:6px; flex-wrap:wrap; align-items:flex-start; }

  /* ç‰Œã®è¦‹ãŸç›®ï¼ˆæ•°å­—é»’ï¼‹è¬èµ¤ï¼ç¸¦æ›¸ãï¼‰ */
  .pai {
    width: var(--w); height: var(--h);
    border-radius: 6px;
    background: linear-gradient(#fff, #f6f6f6);
    border: 1px solid #bdbdbd;
    box-shadow: inset 0 0 0 2px #fff, 0 1px 2px rgba(0,0,0,.06);
    display:flex; align-items:center; justify-content:center;
    writing-mode: vertical-rl; text-orientation: upright;
  }
  .pai .kanji { font-family:"Hiragino Mincho ProN","Yu Mincho","Noto Serif CJK JP",serif; font-weight:700; font-size:22px; color:#000; line-height:1; }
  .pai .man   { font-family:"Hiragino Mincho ProN","Yu Mincho","Noto Serif CJK JP",serif; font-weight:700; font-size:22px; color:#c62828; line-height:1; }
  .pai.small { width:40px; height:54px; }
  .pai.mark  { outline:3px solid #ff9800; outline-offset:2px; }

  .btn { padding:10px 14px; border-radius:12px; border:1px solid #bbb; background:#f7f7f7; font-weight:800; cursor:pointer; }
  .answers { display:flex; gap:8px; flex-wrap:wrap; }
  .ans { border:none; background:transparent; padding:0; cursor:pointer; }
  .ans .pai { transition: transform .05s ease, outline-color .1s; }
  .ans.selected .pai { outline:3px solid #1976d2; outline-offset:2px; transform: translateY(-1px); }
  .ans.correct  .pai { outline:3px solid #2e7d32; outline-offset:2px; }
  .ans.wrong    .pai { outline:3px solid #d32f2f; outline-offset:2px; }

  .muted { opacity:.75; }
  .score { font-weight:800; }
  .small { font-size:12px; color:#666; }
  #msg.error { color:#d32f2f; font-weight:700; }
</style>
</head>
<body>
  <h1>æ¸…ä¸€è‰² ãƒ†ãƒ³ãƒ‘ã‚¤ãƒ»ä½•å¾…ã¡ã‚¯ã‚¤ã‚ºï¼ˆ<span class="muted">è¬å­ã®ã¿</span>ï¼‰</h1>

  <div class="panel row">
    <label><input type="checkbox" id="allowStd" checked /> é¢å­æ‰‹OK</label>
    <label><input type="checkbox" id="allowChiitoi" /> ä¸ƒå¯¾å­OK</label>
  </div>

  <div class="wrap">
    <div class="panel" style="min-width:380px;">
      <div class="row"><strong>å•é¡Œ <span id="qno">1</span></strong>ã€€<span class="score">æ­£è§£ <span id="good">0</span>/<span id="total">0</span></span></div>
      <div class="row small">ä¸‹ã®13æšã§ãƒ†ãƒ³ãƒ‘ã‚¤ã€‚ã‚¢ã‚¬ã‚Œã‚‹ç‰Œï¼ˆè¤‡æ•°å¯ï¼‰ã‚’é¸ã‚“ã§ã€Œè§£ç­”ã™ã‚‹ã€ã€‚</div>
      <div id="hand" class="tiles" style="margin:6px 0 8px;"></div>

      <div class="answers" id="answers"></div>
      <div class="row" style="margin-top:10px;">
        <button type="button" class="btn" id="submit">è§£ç­”ã™ã‚‹ (Enter)</button>
        <button type="button" class="btn" id="reveal">ç­”ãˆã‚’è¡¨ç¤º</button>
        <button type="button" class="btn" id="next">æ¬¡ã®å•é¡Œ (N)</button>
      </div>
      <div class="row small muted" id="msg">â€”</div>
    </div>

    <div class="panel" style="min-width:260px;">
      <div class="row"><strong>æ­£è§£ã®å¾…ã¡</strong></div>
      <div id="waits" class="tiles" style="min-height:70px;"></div>
      <div class="row small">ãƒ‡ãƒãƒƒã‚°</div>
      <pre id="debug" class="small" style="margin:0;">â€”</pre>
    </div>
  </div>

<script>
(()=> {
  // DOM
  const allowStd    = document.getElementById('allowStd');
  const allowChiitoi = document.getElementById('allowChiitoi');
  const handEl = document.getElementById('hand');
  const answersEl = document.getElementById('answers');
  const waitsEl = document.getElementById('waits');
  const msgEl = document.getElementById('msg');
  const debugEl = document.getElementById('debug');
  const qnoEl = document.getElementById('qno');
  const goodEl = document.getElementById('good');
  const totalEl = document.getElementById('total');
  const submitBtn = document.getElementById('submit');
  const revealBtn = document.getElementById('reveal');
  const nextBtn = document.getElementById('next');

  // ä¾‹å¤–ã¯ç”»é¢ã«å‡ºã™
  window.onerror = (m,s,l,c,e)=>{ msgEl.textContent = 'ã‚¨ãƒ©ãƒ¼: '+m; msgEl.classList.add('error'); console.error(m,s,l,c,e); };

  const NUM_KANJI = ['','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];

  // çŠ¶æ…‹
  let counts13 = Array(10).fill(0); // 1..9 åˆè¨ˆ13
  let waits = new Set();
  let qno=0, good=0, total=0;
  let revealed=false;

  // ç‰Œ DOM
  function pai(num, small=false){
    const d = document.createElement('div'); d.className = 'pai'+(small?' small':'');
    const k = document.createElement('span'); k.className='kanji'; k.textContent = NUM_KANJI[num]||'?';
    const m = document.createElement('span'); m.className='man';   m.textContent = 'è¬';
    d.appendChild(k); d.appendChild(m);
    return d;
  }

  // æç”»
  function renderTilesFromCounts(container, cnt){
    container.innerHTML = '';
    for(let i=1;i<=9;i++){
      for(let k=0;k<(cnt[i]||0);k++) container.appendChild(pai(i));
    }
  }
  function renderWaits(show){
    waitsEl.innerHTML=''; if(!show) return;
    [...waits].sort((a,b)=>a-b).forEach(n=>{ const d=pai(n); d.classList.add('mark'); waitsEl.appendChild(d); });
  }

  // å’Œäº†åˆ¤å®šï¼ˆæ¸…ä¸€è‰²å‰æï¼‰
  const sumArr = a=>a.reduce((x,y)=>x+y,0);
  function canMentsu(cnt){
    let i=1; while(i<=9 && cnt[i]===0) i++; if(i>9) return true;
    if(cnt[i]>=3){ cnt[i]-=3; if(canMentsu(cnt)){ cnt[i]+=3; return true; } cnt[i]+=3; }
    if(i<=7 && cnt[i+1]>0 && cnt[i+2]>0){
      cnt[i]--; cnt[i+1]--; cnt[i+2]--;
      if(canMentsu(cnt)){ cnt[i]++; cnt[i+1]++; cnt[i+2]++; return true; }
      cnt[i]++; cnt[i+1]++; cnt[i+2]++;
    }
    return false;
  }
  function isAgariStd(cnt){ // 14æš
    if(sumArr(cnt)!==14) return false;
    for(let j=1;j<=9;j++){
      if(cnt[j]>=2){ cnt[j]-=2; if(canMentsu(cnt)){ cnt[j]+=2; return true; } cnt[j]+=2; }
    }
    return false;
  }
  function isChiitoi(cnt){
    if(sumArr(cnt)!==14) return false;
    let pairs=0; for(let i=1;i<=9;i++){ if(cnt[i]===2) pairs++; else if(cnt[i]===0){} else return false; }
    return pairs===7;
  }
  function waitsFor(c13, stdOK, chiitoiOK){
    const w=new Set(); if(sumArr(c13)!==13) return w;
    for(let t=1;t<=9;t++){
      if(c13[t]===4) continue; // 5æšç›®ã¯ä¸å¯
      const tmp=c13.slice(); tmp[t]++;
      if((stdOK && isAgariStd(tmp.slice())) || (chiitoiOK && isChiitoi(tmp.slice()))) w.add(t);
    }
    return w;
  }

  // å‡ºé¡Œï¼ˆ14æšã®å’Œäº†æ‰‹â†’1æšæŠœãï¼‰
  function randCounts14(){
    const c = Array(10).fill(0);
    while(sumArr(c)<14){
      const i = 1 + Math.floor(Math.random()*9);
      if(c[i]<4) c[i]++;
    }
    return c;
  }
  function randAgari14(stdOK, chiitoiOK){
    for(let tries=0; tries<40000; tries++){
      const c = randCounts14();
      if((stdOK && isAgariStd(c.slice())) || (chiitoiOK && isChiitoi(c.slice()))) return c;
    }
    return null;
  }
  function makeQuestion(){
    const agari = randAgari14(allowStd.checked, allowChiitoi.checked);
    if(!agari){
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç¢ºå®Ÿã«ãƒ†ãƒ³ãƒ‘ã‚¤ï¼‰ï¼š1ã€œ6ã‚’2æšãšã¤ï¼‹7ã‚’1æš â†’ 7å¾…ã¡
      const fb = Array(10).fill(0); [1,2,3,4,5,6].forEach(i=>fb[i]=2); fb[7]=1;
      counts13 = fb; waits = new Set([7]); return;
    }
    let idx; do{ idx = 1 + Math.floor(Math.random()*9); } while(agari[idx]===0);
    agari[idx]--;
    counts13 = agari;
    waits = waitsFor(counts13.slice(), allowStd.checked, allowChiitoi.checked);
    if(waits.size===0) return makeQuestion(); // å¿µã®ãŸã‚
  }

  function drawQuestion(){
    qno++; total++; qnoEl.textContent=String(qno); totalEl.textContent=String(total);
    revealed=false; msgEl.textContent='â€”'; msgEl.classList.remove('error');
    renderTilesFromCounts(handEl, counts13);
    renderWaits(false);

    // å›ç­”ï¼ˆ1ã€œ9ï¼‰è¤‡æ•°é¸æŠ
    answersEl.innerHTML='';
    for(let i=1;i<=9;i++){
      const btn = document.createElement('button'); btn.type='button'; btn.className='ans'; btn.dataset.num=String(i);
      btn.appendChild(pai(i,true));
      btn.addEventListener('click', ()=> btn.classList.toggle('selected'));
      answersEl.appendChild(btn);
    }

    debugEl.textContent = 'æ‰‹ç‰Œ: '+counts13.slice(1).join(', ')+'\nå¾…ã¡: (éè¡¨ç¤º)';
  }

  function judge(){
    if(revealed) return;
    const chosen = new Set([...answersEl.children].filter(b=>b.classList.contains('selected')).map(b=>+b.dataset.num));
    const pick=[...chosen].sort((a,b)=>a-b), ans=[...waits].sort((a,b)=>a-b);
    const correctAll = JSON.stringify(pick)===JSON.stringify(ans);
    if(correctAll){ good++; goodEl.textContent=String(good); msgEl.textContent='ğŸŸ¢ å®Œå…¨æ­£è§£ï¼'; }
    else{
      const wrong = pick.filter(n=>!waits.has(n));
      const missed = ans.filter(n=>!chosen.has(n));
      msgEl.textContent = `ğŸ”´ ä¸æ­£è§£  èª¤é¸æŠ:${wrong.join(',')||'ãªã—'} / è¦‹é€ƒã—:${missed.join(',')||'ãªã—'}`;
    }
    revealed=true; renderWaits(true);
    [...answersEl.children].forEach(el=>{
      const n=+el.dataset.num; el.disabled=true;
      if(waits.has(n)) el.classList.add('correct');
      if(!waits.has(n) && el.classList.contains('selected')) el.classList.add('wrong');
    });
  }

  function next(){ makeQuestion(); drawQuestion(); }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  submitBtn.addEventListener('click', judge);
  revealBtn.addEventListener('click', ()=>{
    if(!revealed){
      revealed=true; renderWaits(true);
      [...answersEl.children].forEach(el=>{ el.disabled=true; if(waits.has(+el.dataset.num)) el.classList.add('correct'); });
      msgEl.textContent='è§£ç­”ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ';
    }
  });
  nextBtn.addEventListener('click', next);
  window.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ judge(); } if(e.key.toLowerCase()==='n'){ next(); } });
  allowStd.addEventListener('change', next);
  allowChiitoi.addEventListener('change', next);

  // åˆå›
  next();
})();
</script>
</body>
</html>
